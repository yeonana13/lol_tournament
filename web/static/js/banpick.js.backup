// ì¤‘ë³µ ë¡œë“œ ë°©ì§€
if (window.BanPickSystem) {
    console.log('âš ï¸ BanPickSystem ì´ë¯¸ ë¡œë“œë¨, ì¬ì‚¬ìš©');
} else {
    console.log('âœ… BanPickSystem ì²˜ìŒ ë¡œë“œ');

class BanPickSystem {
    constructor(sessionId) {
        this.sessionId = sessionId;
        this.currentUser = null;
        this.socket = io();
        this.gameState = {
            phase: 'position_select',
            teams: {
                blue: { TOP: null, JUG: null, MID: null, ADC: null, SUP: null },
                red: { TOP: null, JUG: null, MID: null, ADC: null, SUP: null }
            },
            draft: {
                bans: { blue: [], red: [] },
                picks: { blue: [], red: [] },
                currentTurn: 'blue_ban_1',
                timer: 30
            }
        };
        this.champions = [];
        
        this.loadCurrentUser();
        this.initializeSocket();
        this.loadChampions();
    }

    async loadCurrentUser() {
        try {
            const response = await fetch('/api/user');
            if (response.ok) {
                this.currentUser = await response.json();
                this.displayCurrentUser();
                console.log(`ğŸ‘¤ ìë™ ë¡œê·¸ì¸ ì™„ë£Œ: ${this.currentUser.final_name || this.currentUser.display_name}`);
            } else {
                console.log('ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ - ë¦¬ë””ë ‰íŠ¸ë¨');
            }
        } catch (error) {
            console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    displayCurrentUser() {
        if (this.currentUser) {
            const existingUserInfo = document.querySelector('.user-info');
            if (existingUserInfo) {
                existingUserInfo.remove();
            }

            const userDisplay = document.createElement('div');
            userDisplay.className = 'user-info';
            userDisplay.innerHTML = `
                <img src="${this.currentUser.avatar_url}" alt="ì•„ë°”íƒ€" class="user-avatar">
                <span class="user-name">ğŸ‘¤ ${this.currentUser.final_name || this.currentUser.display_name}</span>
                <a href="/auth/logout" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
            `;
            document.querySelector('.header').appendChild(userDisplay);
        }
    }

    initializeSocket() {
        this.socket.on('connect', () => {
            console.log('ğŸ”Œ WebSocket ì—°ê²°ë¨');
            this.socket.emit('join_session', { 
                session_id: this.sessionId,
                user_info: this.currentUser 
            });
        });

        this.socket.on('game_state_update', (data) => {
            this.gameState = { ...this.gameState, ...data.game_state };
            this.updateUI();
        });

        this.socket.on('position_selected', (data) => {
            this.handlePositionUpdate(data);
        });

        this.socket.on('draft_update', (data) => {
            this.handleDraftUpdate(data);
        });
    }

    async loadChampions() {
        try {
            const response = await fetch(`/api/session/${this.sessionId}`);
            const data = await response.json();
            this.champions = data.champions;
            console.log(`ğŸ“Š ${this.champions.length}ê°œ ì±”í”¼ì–¸ ë¡œë“œë¨`);
        } catch (error) {
            console.error('ì±”í”¼ì–¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    selectPosition(team, position) {
        console.log(`ğŸ¯ í¬ì§€ì…˜ ì„ íƒ ì‹œë„: ${team} ${position}`);
        
        if (!this.currentUser) {
            console.log('âŒ ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ');
            if (typeof positionModal !== 'undefined') {
                positionModal.showLoginRequired();
            } else {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!');
                loginWithDiscord();
            }
            return;
        }

        if (this.gameState.teams[team][position]) {
            console.log('âŒ ì´ë¯¸ ì„ íƒëœ í¬ì§€ì…˜');
            if (typeof positionModal !== 'undefined') {
                positionModal.showError('ì´ë¯¸ ì„ íƒëœ í¬ì§€ì…˜ì…ë‹ˆë‹¤!', 'âš ï¸');
            } else {
                alert('ì´ë¯¸ ì„ íƒëœ í¬ì§€ì…˜ì…ë‹ˆë‹¤!');
            }
            return;
        }

        const userName = this.currentUser.final_name || this.currentUser.display_name;
        const currentPosition = this.findUserPosition(userName);
        
        if (currentPosition) {
            console.log(`ğŸ”„ ê¸°ì¡´ í¬ì§€ì…˜ì—ì„œ ì´ë™: ${currentPosition.team} ${currentPosition.position} â†’ ${team} ${position}`);
            console.log('ğŸ” positionModal íƒ€ì…:', typeof positionModal);
            console.log('ğŸ” positionModal ê°ì²´:', positionModal);
            
            if (typeof positionModal !== 'undefined' && positionModal && positionModal.showMoveConfirm) {
                console.log('âœ… ëª¨ë‹¬ ì‚¬ìš©');
                positionModal.showMoveConfirm(
                    currentPosition.team, 
                    currentPosition.position, 
                    team, 
                    position, 
                    () => {
                        this.leavePosition(currentPosition.team, currentPosition.position);
                        this.executePositionSelection(team, position);
                    }
                );
            } else {
                console.log('âŒ ëª¨ë‹¬ ì—†ìŒ, ê¸°ë³¸ confirm ì‚¬ìš©');
                if (confirm(`í˜„ì¬ ${currentPosition.team} ${currentPosition.position}ì— ìˆìŠµë‹ˆë‹¤. ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    this.leavePosition(currentPosition.team, currentPosition.position);
                    this.executePositionSelection(team, position);
                }
            }
            return;
        }

        this.executePositionSelection(team, position);
    }

    executePositionSelection(team, position) {
        const userName = this.currentUser.final_name || this.currentUser.display_name;
        console.log(`âœ… í¬ì§€ì…˜ ì„ íƒ ì‹¤í–‰: ${userName} â†’ ${team} ${position}`);
        
        // ë¨¼ì € ê¸°ì¡´ í¬ì§€ì…˜ì—ì„œ ì œê±° (í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œë„)
        const currentPosition = this.findUserPosition(userName);
        if (currentPosition) {
            this.gameState.teams[currentPosition.team][currentPosition.position] = null;
            console.log(`ğŸ—‘ï¸ ê¸°ì¡´ í¬ì§€ì…˜ í´ë¦¬ì–´: ${currentPosition.team} ${currentPosition.position}`);
        }
        
        // ìƒˆ í¬ì§€ì…˜ì— í• ë‹¹ (í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œë„)
        this.gameState.teams[team][position] = userName;
        console.log(`ğŸ“ ìƒˆ í¬ì§€ì…˜ ì„¤ì •: ${team} ${position} = ${userName}`);
        
        // ì„œë²„ì— ì „ì†¡
        this.socket.emit('select_position', {
            session_id: this.sessionId,
            team: team,
            position: position,
            user_name: userName,
            discord_id: this.currentUser.id,
            avatar_url: this.currentUser.avatar_url
        });
        
        // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        this.updatePositionSlots();
        this.checkAllPositionsFilled();
        
        // ì„±ê³µ ëª¨ë‹¬ í‘œì‹œ (ìˆìœ¼ë©´)
        if (typeof positionModal !== 'undefined') {
            positionModal.showPositionSelected(team, position, userName);
        }
    }

    findUserPosition(userName) {
        for (const team of ['blue', 'red']) {
            for (const position of ['TOP', 'JUG', 'MID', 'ADC', 'SUP']) {
                if (this.gameState.teams[team][position] === userName) {
                    return { team, position };
                }
            }
        }
        return null;
    }

    handlePositionUpdate(data) {
        console.log(`ğŸ“¡ í¬ì§€ì…˜ ì—…ë°ì´íŠ¸ ë°›ìŒ:`, data);
        console.log(`ğŸ“Š ì—…ë°ì´íŠ¸ ì „ ìƒíƒœ:`, JSON.stringify(this.gameState.teams, null, 2));
        
        this.gameState.teams[data.team][data.position] = data.user_name;
        
        console.log(`ğŸ“Š ì—…ë°ì´íŠ¸ í›„ ìƒíƒœ:`, JSON.stringify(this.gameState.teams, null, 2));
        
        this.updatePositionSlots();
        this.checkAllPositionsFilled();
    }

    updatePositionSlots() {
        ['blue', 'red'].forEach(team => {
            ['TOP', 'JUG', 'MID', 'ADC', 'SUP'].forEach(position => {
                const slot = document.querySelector(`[data-team="${team}"][data-position="${position}"]`);
                if (!slot) return;
                
                const player = this.gameState.teams[team][position];
                const playerInfo = slot.querySelector('.player-info');
                
                if (player) {
                    slot.classList.add('occupied');
                    
                    const isCurrentUser = this.currentUser && player === (this.currentUser.final_name || this.currentUser.display_name);
                    if (isCurrentUser) {
                        slot.classList.add('current-user');
                    } else {
                        slot.classList.remove('current-user');
                    }
                    
                    playerInfo.innerHTML = `
                        <span class="player-name">${player}</span>
                        ${isCurrentUser ? 
                            `<button class="btn btn-leave" onclick="banPickSystem.leavePosition('${team}', '${position}')">ë‚˜ê°€ê¸°</button>` :
                            '<span class="occupied-text">ì„ íƒë¨</span>'
                        }
                    `;
                } else {
                    slot.classList.remove('occupied', 'current-user');
                    playerInfo.innerHTML = `
                        <span class="waiting-text">í¬ì§€ì…˜ ì„ íƒ ëŒ€ê¸° ì¤‘</span>
                        <button class="btn btn-join" onclick="banPickSystem.selectPosition('${team}', '${position}')">ì°¸ê°€</button>
                    `;
                }
            });
        });
    }

    leavePosition(team, position) {
        console.log(`ğŸšª í¬ì§€ì…˜ ë‚˜ê°€ê¸°: ${team} ${position}`);
        this.socket.emit('leave_position', {
            session_id: this.sessionId,
            team: team,
            position: position
        });
    }

    checkAllPositionsFilled() {
        const totalFilled = Object.values(this.gameState.teams.blue).filter(p => p).length +
                           Object.values(this.gameState.teams.red).filter(p => p).length;
        
        const startButton = document.getElementById('startDraftBtn');
        if (startButton) {
            if (totalFilled === 10) {
                startButton.disabled = false;
                startButton.textContent = 'ğŸš€ ë°´í”½ ì‹œì‘í•˜ê¸°';
                startButton.onclick = () => this.startDraft();
            } else {
                startButton.disabled = true;
                startButton.textContent = `í¬ì§€ì…˜ ì„ íƒ ì¤‘... (${totalFilled}/10)`;
            }
        }
    }

    startDraft() {
        this.socket.emit('start_draft', { session_id: this.sessionId });
        this.gameState.phase = 'draft';
        this.showDraftInterface();
    }

    showDraftInterface() {
        document.getElementById('positionSelectInterface').style.display = 'none';
        document.getElementById('draftInterface').style.display = 'block';
        document.getElementById('currentPhase').textContent = 'ë°´í”½ ë“œë˜í”„íŠ¸';
        this.createChampionGrid();
        this.updateDraftState();
    }

    createChampionGrid() {
        const championGrid = document.getElementById('championGrid');
        if (!championGrid) return;
        
        championGrid.innerHTML = '';
        
        this.champions.forEach(champion => {
            const championCard = document.createElement('div');
            championCard.className = 'champion-card';
            championCard.setAttribute('data-champion', champion.english_name);
            championCard.innerHTML = `
                <img src="${champion.image_url}" alt="${champion.korean_name}" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                <div class="champion-placeholder" style="display:none;">${champion.korean_name}</div>
                <div class="champion-name">${champion.korean_name}</div>
            `;
            championCard.onclick = () => this.selectChampion(champion.english_name);
            championGrid.appendChild(championCard);
        });
    }

    selectChampion(championName) {
        if (this.gameState.phase !== 'draft') return;
        
        this.socket.emit('select_champion', {
            session_id: this.sessionId,
            champion: championName,
            action: this.getCurrentAction()
        });
    }

    getCurrentAction() {
        const turn = this.gameState.draft.currentTurn;
        if (turn.includes('ban')) return 'ban';
        if (turn.includes('pick')) return 'pick';
        return 'ban';
    }

    handleDraftUpdate(data) {
        this.gameState.draft = data.draft_state;
        this.updateDraftState();
    }

    updateDraftState() {
        this.updateBanPickDisplay();
        this.updateCurrentTurn();
        this.updateTimer();
    }

    updateBanPickDisplay() {
        ['blue', 'red'].forEach(team => {
            const banContainer = document.getElementById(`${team}Bans`);
            if (banContainer) {
                banContainer.innerHTML = '';
                this.gameState.draft.bans[team].forEach(champion => {
                    const banDiv = document.createElement('div');
                    banDiv.className = 'ban-champion';
                    banDiv.textContent = champion;
                    banContainer.appendChild(banDiv);
                });
            }
        });

        ['blue', 'red'].forEach(team => {
            const pickContainer = document.getElementById(`${team}Picks`);
            if (pickContainer) {
                pickContainer.innerHTML = '';
                this.gameState.draft.picks[team].forEach((champion, index) => {
                    const positions = ['TOP', 'JUG', 'MID', 'ADC', 'SUP'];
                    const pickDiv = document.createElement('div');
                    pickDiv.className = 'pick-champion';
                    pickDiv.innerHTML = `
                        <div class="position">${positions[index]}</div>
                        <div class="champion">${champion}</div>
                    `;
                    pickContainer.appendChild(pickDiv);
                });
            }
        });
    }

    updateCurrentTurn() {
        const turnIndicator = document.getElementById('currentTurn');
        if (turnIndicator) {
            const turn = this.gameState.draft.currentTurn;
            turnIndicator.textContent = this.getTurnDescription(turn);
        }
    }

    getTurnDescription(turn) {
        const turnMap = {
            'blue_ban_1': 'ë¸”ë£¨íŒ€ 1ë²ˆì§¸ ë°´',
            'red_ban_1': 'ë ˆë“œíŒ€ 1ë²ˆì§¸ ë°´',
            'red_ban_2': 'ë ˆë“œíŒ€ 2ë²ˆì§¸ ë°´',
            'blue_ban_2': 'ë¸”ë£¨íŒ€ 2ë²ˆì§¸ ë°´',
            'blue_pick_1': 'ë¸”ë£¨íŒ€ 1ë²ˆì§¸ í”½',
            'red_pick_1': 'ë ˆë“œíŒ€ 1ë²ˆì§¸ í”½',
        };
        return turnMap[turn] || turn;
    }

    updateTimer() {
        const timerElement = document.getElementById('timer');
        if (timerElement) {
            timerElement.textContent = this.gameState.draft.timer;
        }
    }

    updateUI() {
        if (this.gameState.phase === 'position_select') {
            this.updatePositionSlots();
            this.checkAllPositionsFilled();
        } else if (this.gameState.phase === 'draft') {
            this.updateDraftState();
        }
    }
}

// ì „ì—­ ë³€ìˆ˜ë¡œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
let banPickSystem;

document.addEventListener('DOMContentLoaded', function() {
    const sessionId = document.querySelector('[data-session-id]').dataset.sessionId;
    banPickSystem = new BanPickSystem(sessionId);
});


// ì „ì—­ í• ë‹¹
window.BanPickSystem = BanPickSystem;
}